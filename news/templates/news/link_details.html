{% extends 'news/base.html' %}

{% load mptt_tags %}

{% block jqueryarea %}
<script language="JavaScript" type="text/javascript" src="/site_media/js/voting.js">
<!--
//-->
</script>
<script language="JavaScript" type="text/javascript">
<!--

function processComment(data) { 
    // 'data' is the json object returned from the server
		el = $('#comments') ;
    //el.prepend(data['text']);
		el.prepend(data['dom']); 
		handle_click();
		handle_commentreply();
}
function processTag(data){
	el = $('#tags');
	if (data['tagged']){
		el.prepend(data['dom']);
	}
}
function processCommentReply(data){
	el = 	$('#child-'+data['parent_id']);
	el.prepend(data['dom']);
	handle_commentreply();
	handle_click();
}
function showError(data){
  alert(data);
}
$(document).ready(function(){
	 comment_url = $('#commentform').attr('action')+'?ajax=1';
	 $('#commentform').ajaxForm({
	  resetForm: true,
		success: processComment,
		url: comment_url,
		dataType: 'json'
	 });
	 
	 tag_url = $('#tagform').attr('action')+'?ajax=1'
	 	 $('#tagform').ajaxForm({
	   resetForm: true,		 
		 url: tag_url,
		 dataType:'json',
		 success: processTag,
		 failure: showError
		 })
});
handle_commentreply = function(){
		 $('.commentreply').ajaxForm({
		 resetForm: true,		 
		 dataType:'json',
		 success: processCommentReply
		 })

  $('.commentreply').hide();
	$('.reply:not(.handled)').click(function(){
	   $(this).parent().children().filter('.commentreply').toggle().addclass;
		 return false;
	});
	$('.reply:not(.handled)').addClass('handled');
	}
$(document).ready(handle_commentreply);
//-->
</script>


{% endblock %}


{% block contents %}

{% include 'news/link_row.html' %}

<div class="commentform">
<form action="." method="post" id="commentform">
<div>
{{form.as_p}}
<input type="submit" name="comment" value="comment" />
</div>
</form>
</div>

<div id="comments">
{% for comment, structure in comments|tree_info %}
{% if structure.new_level %}<ul><li>{% else %}</li><li>{% endif %}
{% include 'news/comment_row.html' %}
{% for level in structure.closed_levels %}</li></ul>{% endfor %}

{% endfor %}
</div>
{% endblock %}

{% block sidebar %}
<h2>tags</h2>
<form action="." method="post" id="tagform">
{{tag_form}}
<input type="submit" name="taglink" value="taglink" />
</form>
<ul id="tags">
{% for tag in link.linktag_set.get_topic_tags %}
<li>
<a href="{{tag.tag.get_absolute_url}}">{{tag.tag.text}}</a>
</li>
{% endfor %}

</ul>
{% endblock %}